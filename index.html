<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Vocifery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/social-buttons.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/bootstrap-responsive.css">

<style type="text/css">
html {
	height: 100%;
}

body {
	height: 100%;
	color: #E8F0F3;
	font-family: 'Roboto', sans-serif;
}

/* Large desktop */
@media ( min-width : 980px) {
	body {
		padding-top: 60px;
	}
	.linediv-l {
		border-right: 1px white solid;
	}
	.linediv-r {
		border-left: 1px white solid;
	}
}

/* Landscape phones and down */
@media ( max-width : 480px) {
	.copy {
		padding: 2.5% 10%;
	}
	.linediv-l {
		border-bottom: 1px white solid;
	}
	.linediv-r {
		border-top: 1px white solid;
	}
}

/* All form factors */

/* Main body and headings */
.heading,.subheading {
	font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
	text-align: center;
}

p.lead {
	padding-top: 1.5%;
	font-size: 24px;
	line-height: 30px;
}

p {
	font-size: 18px;
	line-height: 24px;
}

.social {
	text-align: center;
}

/* Marketing Copy and Footer */
.copy {
	padding-top: 2.5%;
	padding-bottom: 2.5%;
	text-align: justify;
}

.asset {
	padding: 2.5% 0%;
}

.footer {
	color: #cccccc;
	text-align: center;
}

.footer p {
	font-size: 11px;
}

.footer a {
	color: #ccccff;
}

#search-result {
	overflow: auto;
}

#candidate-answers {
	overflow: auto;
	padding-left: 0;
}

#candidate-answers ul {
	list-style-type: none;
}

#candidate-answers li {
	padding-bottom: 20px;
}

.vocifery-info {
	font-family: inherit;
	font-weight: bold;
	line-height: 26px;
	color: inherit;
	font-size: 21.25px;
	color: #0063ac;
	text-rendering: optimizelegibility;
}

.vocifery-info span {
	padding-left: 20px;
}

/* http://support.addthis.com/customer/portal/questions/1136093-share-buttons-in-center-position */
div.addthis_toolbox {
	width: 180px;
	margin: 0 auto;
}

.center {
	text-align: center;
}

.header {
	color: #FFFFFF;
	font-size: 20px;
	font-style: normal;
	font-variant: normal;
	font-weight: normal;
	line-height: 1.4;
	text-shadow: rgba(0, 0, 0, 0.658824) 0 1px 2px;
}

.heading {
  font-size: 64px;
  font-weight: bold;
  line-height: 64px;
  margin-bottom: 30px;
  margin-top: 100px;
  text-shadow: rgba(0, 0, 0, 0.498039) 0 2px 5px;
}

.vpad {
	padding: 30px 0;
}

.detail {
  color: #EEEEEE;
  font-size: 20px;
  font-weight: 300;
  line-height: 1.25;
  margin-bottom: 40px;
  padding: 10px;
}

.detail h1 {
  font-size: 60px;
  font-weight: 300;
  letter-spacing: -1px;
  line-height: 1;
  margin: 10px 0 10px;
  color: #EEEEEE;
}

.detail h1 span {
}

.detail h2,
.detail h3 {
  font-weight: 200;
  margin-bottom: 5px;
}

.detail p {
  font-size: 16px;
  line-height: 1.5;
  font-weight: 100;
}

.detail img {
  margin: 5px auto;
}

.detail ul {
  list-style-type: none;
}

.detail li {
  font-size: 16px;
}

.dark {
	background-color: #333333;
}

.purple {
	background-color: #9B95D4;
}

.blue {
	background-color: #1581F5;
}

.green {
	background-color: #C1D739;
}

.well, .modal-body {
	color: #333333;	
}

#main {
	padding-bottom: 360px; 
}

#wrapper {
	min-height: 100%;
  position: relative;
}

footer {
	height: 360px; 
  width:100%;
  position: absolute;
  left: 0;
  bottom: 0; 
}

div.evidence-box {
	border: 0;
	background-color: #FEFEFA;
}
</style>

<script type="text/javascript">
	var questionTypes = "when|where|why|who|whom|what|which|how"
	var pattern = new RegExp("^(" + questionTypes + ")(.+)\\?$", "i");
	function validateQuestion(question) {
		if (!pattern.test(question)) {
			$('#query-validator').modal('show')
			return false;
		}
		return true;
	}
</script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-42925454-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>
<body>

	<div id="wrapper">
		<header>
			<div class="navbar navbar-inverse navbar-fixed-top">
				<div class="navbar-inner">
					<div class="container">
						<div class="nav-collapse collapse social">
							<ul class="nav">
								<li><a id="contact-us" name="contact-us" href="#">Contact Us</a></li>
							</ul>
							<!-- AddThis Button BEGIN -->
							<ul class="nav addthis_toolbox addthis_default_style addthis_32x32_style pull-right">
								<li><a class="addthis_button_linkedin"></a></li>
								<li><a class="addthis_button_facebook"></a></li>
								<li><a class="addthis_button_twitter"></a></li>
							</ul>
							<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
							<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51fc971a672b058a"></script>
							<!-- AddThis Button END -->
						</div>
					</div>
				</div>
			</div>
	
			<div class="container">
				<div class="row-fluid center vpad">
					<form action="#" id="query"
						name="query" class="form-search">
					<input class="input-xxlarge search-query" type="text"
						maxlength="256" id="question" name="question" /> <a class="btn btn-primary"
						href="#" onclick="$(this).closest('form').submit()"><i
						class="icon-bullhorn"></i> Ask</a>
					</form>
				</div>	
			</div>
			
			<div class="container-fluid">
				<!-- Animated icons from http://preloaders.net -->
				<div class="row-fluid">
					<div id="question-parse" class="span10 offset1 hide well">
					<h5 class="text-left">Question Context</h5>
					<span id="wait-parse" class="vocifery-info hide"><img
							src="img/355.gif" alt="Parsing ..." /><span>Parsing
								...</span></span>
					<table class="table table-bordered table-condensed">
						<thead>
		        			<tr>
		            			<th>Answer Type</th>
		            			<th>Action</th>
		            			<th>Focus</th>
		            			<th>Target</th>
		            			<th>Qualifiers</th>
		        			</tr>
		    			</thead>
		    			<tbody id="question-segment">
		    			</tbody>
					</table>
					</div>	
				</div>
				
				<div class="row-fluid section1">
					<div id="search-div" class="span6 offset1 hide well">
						<h5 class="text-left">Search Results</h5>
						<span id="wait-search" class="vocifery-info hide"><img
							src="img/355.gif" alt="Searching ..." /><span>Searching
								...</span></span>
						<p id="search-result"></p>
					</div>
					<div id="answer-div" class="span4 hide well">
						<h5 class="text-left">Detailed Answers</h5>
						<span id="wait-think" class="vocifery-info hide"><img
							src="img/355.gif" alt="Thinking ..." /><span>Thinking
								...</span></span>
						<div id="candidate-answers"></div>
					</div>
				</div>
			</div>
		</header>
		
		<div id="main">&nbsp;</div>
		
		<footer>
		
			<div class="dark detail">
				<div class="row-fluid">
					<div class="span4 center">
						<h3 class="purple">Description</h3>
						<p>Vocifery is a question answering application for Wikipedia. 
					   	Questions are decomposed into features such as keywords that are then submitted to the Wikipedia search engine.
					   	Deep search is then performed on search results to find answers that best satisfy the question.	
					   	This project is open source and the code is in <a href="https://github.com/datjandra/bitstarter">Github</a>.
						</p>
					</div>
		
					<div class="span4 center">
						<h3 class="blue">Sample Questions</h3>
						<ul>
							<li>Where is the wettest spot on earth?</li>
							<li>How fast is the speed of sound?</li>
							<li>What evidence is there for the grandmother cell?</li>
							<li>What is the meaning of life, the universe, and everything?</li>
						</ul>
					</div>
		
					<div class="span4 center">
						<h3 class="green">Notes</h3>
						<p>
						Vocifery currently searches for answers from Wikipedia only.
						It is not a chatbot or general search engine.
						Due to system performance constraints, the deep search is limited to just a few results from Wikipedia search.
						Answer relevance may suffer for this reason.
						</p>
					</div>
				</div>
			</div>
		
			<p class="footer">This work is licensed under the <a
				href="http://creativecommons.org/licenses/by-sa/3.0/">CC By-SA
				3.0 </a>, without all the cruft that would otherwise be put at the
				bottom of the page.
			</p>
		</footer>
	</div>

	<div id="query-validator" class="modal hide fade">
		<div class="modal-body">
			<p>Question must begin with one of
				when|where|why|who|whom|what|which|how and end with question mark.</p>
		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
		</div>
	</div>
	
	<div id="contact-dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modal-label" aria-hidden="true">
    	<div class="modal-header">
        	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        	<h3 id="modal-header">Contact Information</h3>
    	</div>
    	<div class="modal-body">
        	<form id="email-form" name="email-form">
		  		<div class="row">
		  			<div class="span5">
		  				<div class="control-group">
						<label>Name</label>
						<input name="name" id="name" type="text" class="span3">
						</div>
						<div class="control-group">
							<label>Email</label>
							<input name="email" id="email" type="text" class="span3">
						</div>
						<div class="control-group">
							<label>Subject</label>
							<input name="subject" id="subject" type="text" class="span3">
						</div>
						<div class="control-group">
							<label>Message</label>
							<textarea name="message" id="message" class="input-xlarge span5" rows="5"></textarea>
						</div>
		  			</div>
				</div>
			</form>	
    	</div>
    	<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
			<button id="email-submit" name="email-submit" class="btn btn-primary">Send</button>
		</div>
	</div>
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="js/bootstrap.js"></script>
	
	<script>
		var request;
		var base = "http://vocifery-garudasystems.rhcloud.com";
		var askUrl = base + "/ask";
		var fetchUrl = base + "/fetch";
		var thinkUrl = base + "/think";
		var pingUrl = base + "/ping";
		// var pingUrl = base + "/ask?question=What%20time%20is%20it%3F";
		var MAX_FETCHES = 2;
		var sortedItems = null;
		
		$.get(pingUrl, function(data) {
			console.log(data);	
		});
		
		$("#contact-us").click(	
			function(event) {
				$('#contact-dialog').modal('show');	
			}
		);
		
		$('#email-submit').click(
			function(event) {
				event.preventDefault();	
				$.post('/email',
					$('#email-form').serialize(),
					function(data, status, xhr) {
						console.log(status);
					}
				);
				$('#contact-dialog').modal('hide');	
			}
		);
		
		function fireEvent(event, input, url, task) {
			return task(event, input, url);
		}
		
		function isEmpty(str) {
			return (!str || 0 === str.length);
		}
		
		var seekAnswers = function(event, input, url) {
			var searchResults = JSON.stringify(input);
			var posting = $.post(url, {
				timeout: 60000,
				searchResults: searchResults
			});
			
			posting.done(function(data) {
				var candidates = data;
				if (candidates.length > 0) {
					$("#answer-div").show();
				}
				
				var candidateAnswers = $("#candidate-answers");
				candidateAnswers.empty().html("<ul>");
				var list = candidateAnswers.find("ul");
				for (var i = 0; i < candidates.length; i++) {
					var answer = candidates[i];
					list.append("<li>");
					list.append("<a href='" + answer.url + "'>" + answer.hypothesis + "</a>");
					list.append("<div class='well evidence-box'>" + answer.evidence + "</div>");
					list.append("</li>");
				}
				candidateAnswers.append("</ul>");
				sortedItems = null;
			});
			
			posting.fail(function(xhr, textStatus, errorThrown) {	
				if ( window.console && window.console.log ) {
					window.console.log(xhr.responseText);
				}
				$("#answer-div").hide();
			});
		}
		
		function fetchItemContents(event, url, searchResults, itemIndex) {
			if (itemIndex >= MAX_FETCHES) {
				fireEvent(event, searchResults, thinkUrl, seekAnswers);
				return;
			}
			
			var item = sortedItems[itemIndex].item;
			$.ajax({
				url: url,
				type: 'POST',
				data: {
					url: encodeURIComponent(item.url)
				},
				success: function(response) {
					item.documentText = response.text;
					fetchItemContents(event, url, searchResults, itemIndex+1);
				},
				error: function(xhr, textStatus, thrownError) {
					if ( window.console && window.console.log ) {
						window.console.log(textStatus);
					}
					fetchItemContents(event, url, searchResults, itemIndex+1);
				}
			});		
		}
		
		var fetchContent = function(event, input, url) {
			var searchResults = input;
			fetchItemContents(event, url, searchResults, 0);
		}
		
		var askQuestion = function(event, input, url) {
			if (!validateQuestion(input)) {
				event.preventDefault();
				return false;
			}

			if (request) {
				request.abort();
			}
			event.preventDefault();
			
			$("#search-div").hide();
			$("#answer-div").hide();
			$("#question-parse").show();
			$("#wait-parse").show();
			
			var posting = $.post(url, {
				question: input
			});
			
			posting.done(function(response) {
				var row = "<tr><td>" + (response.semanticMap.ANSWER_TYPE ? response.semanticMap.ANSWER_TYPE : "-")
						 + "</td><td>" + (response.semanticMap.ACTION ? response.semanticMap.ACTION : "-")
				 		 + "</td><td>" + (response.semanticMap.FOCUS ? response.semanticMap.FOCUS : "-")
						 + "</td><td>" + (response.semanticMap.TARGET ? response.semanticMap.TARGET : "-")
						 + "</td><td>" + (response.semanticMap.QUALIFIERS ? response.semanticMap.QUALIFIERS : "-")
						 + "</td></tr>";
				$("#question-segment").empty().html(row);
				
				$("#search-div").show();
				$("#search-result").empty().html("<ul>")
				var list = $("#search-result").find("ul");
				
				var keywords = response.semanticMap.KEYWORDS.split(', ');
				var keywordSet = {};
				for (var i=0; i<keywords.length; i++) {
					keywordSet[keywords[i]] = true;
				}
				
				sortedItems = new Array();
				var feeds = response.feeds;
				for (var i = 0; i < feeds.length; i++) {
					var feed = feeds[i];
					var source = feed.source;
					var items = feed.items;
					for (var j = 0; j < items.length; j++) {
						var item = items[j];
						list.append("<li>(Source: " + source
								+ ") <a href='" + item.url + "'>"
								+ item.title + "</a><br/>" + item.snippet
								+ "</li>");
						
						var matches = 0;
						var terms = item.title.split(/[ ,]+/);
						for (var k = 0; k < terms.length; k++) {
							if (keywordSet[terms[k]]) {
								matches++;
							}
						}
						var tuple = { item: item, matches: matches };
						sortedItems.push(tuple);
					}
				}
				
				sortedItems.sort(function(a, b) {
					return ( a.matches > b.matches ? 1 : (a.matches < b.matches ? -1 : 0) );
				});
				
				$("#search-result").append("</ul>");
				$("#wait-parse").hide();
				fireEvent(event, response, fetchUrl, fetchContent);
			});
		}
		
		$("#query").submit(	
			function(event) {
				var input = $(this).find('input[name="question"]').val();
				fireEvent(event, input, askUrl, askQuestion);
				return false;		
			}
		)
	</script>
	
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-42925454-1', 'herokuapp.com');
	  ga('send', 'pageview');
	</script>
</body>
</html>
